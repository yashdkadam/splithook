<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>Document</title>
  </head>
  <body>
    <div class="navbar bg-base-100">
      <div class="navbar-start">
        <div class="dropdown">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h7"
              />
            </svg>
          </div>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow"
          >
            <li><a href="/admin/stocks">Stocks</a></li>
            <li><a href="/admin/logs">Logs</a></li>
            <li><a href="/admin/settings">Settings</a></li>
          </ul>
        </div>
      </div>
      <div class="navbar-center">
        <a class="btn btn-ghost text-2xl">SPLITHOOK</a>
      </div>
      <div class="navbar-end">
        <div class="dropdown dropdown-end">
          <div
            tabindex="0"
            role="button"
            class="btn btn-ghost btn-circle avatar"
          >
            <div class="w-10 rounded-full">
              <img
                alt="Tailwind CSS Navbar component"
                src="https://img.daisyui.com/images/stock/photo-1534528741775-53994a69daeb.webp"
              />
            </div>
          </div>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow"
          >
            <li>
              <a class="justify-between">
                Profile
                <span class="badge">New</span>
              </a>
            </li>
            <li><a>Settings</a></li>
            <li><button onclick="localStorage.clear();window.location.reload();" >Logout</button></li>

          </ul>
        </div>
      </div>
    </div>
    <div class="flex items-center justify-center">
      <div class="">
        <h1 class="text-center">Stocks</h1>

        <div class="relative">
          <label class="input input-bordered flex items-center gap-2 w-full">
            <input
              type="text"
              class="grow border p-2 rounded-md"
              placeholder="Search"
              id="search-input"
            />
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 16 16"
              fill="currentColor"
              class="h-4 w-4 opacity-70"
            >
              <path
                fill-rule="evenodd"
                d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
                clip-rule="evenodd"
              />
            </svg>
          </label>
          <ul
            id="suggestions"
            class="absolute bg-white border mt-1 rounded-md w-full shadow-lg hidden"
          >
            <!-- Suggestions will appear here -->
          </ul>
        </div>

        <script>
          const searchInput = document.getElementById("search-input");
          const suggestionsList = document.getElementById("suggestions");
          suggestionsList.style = 'z-index: 9999;';

          searchInput.addEventListener("input", async function () {
            const query = searchInput.value.trim();

            // Hide suggestions if input is empty
            if (query === "") {
              suggestionsList.innerHTML = "";
              suggestionsList.classList.add("hidden");
              return;
            }

            // Fetch results from the API
            try {
              const response = await fetch(
                `http://localhost:5000/stocks/${query}`
              );
              const data = await response.json();

              // Clear previous suggestions
              suggestionsList.innerHTML = "";

              // Check if data is returned
              if (data.length === 0) {
                suggestionsList.classList.add("hidden");
                return;
              }

              // Populate suggestions
              data.forEach((item) => {
                const listItem = document.createElement("li");
                listItem.textContent = `${item.name} (${item.symbol})`;
                listItem.classList.add(
                  "p-2",
                  "hover:bg-gray-100",
                  "cursor-pointer",
                  "z-40"
                );

                // Add click event to send the request and reload
                listItem.addEventListener("click", async () => {
                  await fetch(
                    `http://localhost:5000/stocks/add/${item.symbol}`
                  );
                  location.reload(); // Reloads the page
                });

                suggestionsList.appendChild(listItem);
              });

              // Show the suggestions list
              suggestionsList.classList.remove("hidden");
            } catch (error) {
              console.error("Error fetching data:", error);
            }
          });

          // Hide suggestions on click outside
          document.addEventListener("click", (event) => {
            if (!event.target.closest(".relative")) {
              suggestionsList.classList.add("hidden");
            }
          });
        </script>
        <div class="overflow-x-auto">
          <table class="table w-full border">
            <!-- head -->
            <thead>
              <tr>
                <th>Name</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody id="stocks-table-body" style="z-index: -99;">
              <!-- Rows will be rendered here -->
            </tbody>
          </table>
        </div>

        <script>
          // for user validation before page load
          document.addEventListener("DOMContentLoaded", async () => {
            if (
              localStorage.getItem("username") == null ||
              localStorage.getItem("type") == null || (localStorage.getItem("username") && localStorage.getItem("type") != 'admin')
            ) {
              window.location.href = '/login';
            }
          });

          // Function to fetch and render data into the table
          async function fetchAndRenderStocks() {
            try {
              const response = await fetch(
                "http://localhost:5000/admin/stocks/get"
              );
              const data = await response.json();

              const tbody = document.getElementById("stocks-table-body");
              tbody.innerHTML = ""; // Clear any existing rows

              // Iterate over each stock symbol in the response and create a row
              data.forEach((stock) => {
                const row = document.createElement("tr");

                // Name column
                const nameCell = document.createElement("td");
                nameCell.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="font-bold">${stock}</div>
            </div>`;
                row.appendChild(nameCell);

                // Delete button column
                const deleteCell = document.createElement("td");
                deleteCell.innerHTML = `
            <button class="btn" onclick="deleteStock('${stock}')">
              <i class="fa-solid fa-xmark fa-lg"></i>
            </button>`;
                row.appendChild(deleteCell);

                tbody.appendChild(row);
              });
            } catch (error) {
              console.error("Error fetching stocks:", error);
            }
          }

          // Function to handle stock deletion
          async function deleteStock(stockSymbol) {
            try {
              await fetch(
                `http://localhost:5000/admin/stocks/delete/${stockSymbol}`,
                {
                  method: "DELETE",
                }
              );
              fetchAndRenderStocks(); // Refresh table after deletion
            } catch (error) {
              console.error(`Error deleting stock ${stockSymbol}:`, error);
            }
          }

          // Fetch and render stocks on page load
          document.addEventListener("DOMContentLoaded", fetchAndRenderStocks);
        </script>
      </div>
    </div>

    <input type="checkbox" id="my_modal_6" class="modal-toggle" />
    <div class="modal" role="dialog">
      <div class="modal-box">
        <form method="dialog">
          <label
            for="my_modal_6"
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
            >âœ•</label
          >
        </form>
        <h3 class="text-lg font-bold">Warning!</h3>
        <p class="py-4">Do you want to delete this stock?</p>
        <div class="flex justify-end">
          <div class="modal-action m-1">
            <label for="my_modal_6" class="btn">Yes</label>
          </div>
          <div class="modal-action m-1">
            <label for="my_modal_6" class="btn">No</label>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.tailwindcss.com"></script>
  </body>
</html>
