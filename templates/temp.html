<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="p-10">

  <!-- Dropdown for Adding Stock -->
  <div class="mb-8">
    <label class="input input-bordered flex items-center gap-2 w-64">
      <select id="stock-dropdown" class="grow border p-2 rounded-md">
        <option value="">Select a Stock to Add</option>
        <!-- Options will be dynamically populated here -->
      </select>
    </label>
  </div>

  <!-- Table for Managing Stocks -->
  <div class="overflow-x-auto">
    <table class="table w-full border">
      <!-- Table Head -->
      <thead>
        <tr>
          <th>Name</th>
          <th>Quantity</th>
          <th>Delete</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody id="stocks-table-body">
        <!-- Rows will be dynamically populated here -->
      </tbody>
    </table>
  </div>

  <script>
    // Fetch stock symbols for dropdown
    async function fetchAndPopulateStocks() {
      try {
        const response = await fetch("http://localhost:5000/admin/stocks/get");
        const stocks = await response.json();
        const dropdown = document.getElementById("stock-dropdown");

        dropdown.innerHTML = "<option value=''>Select a Stock to Add</option>";
        stocks.forEach(stock => {
          const option = document.createElement("option");
          option.value = stock;
          option.textContent = stock;
          dropdown.appendChild(option);
        });
      } catch (error) {
        console.error("Error fetching stocks:", error);
      }
    }

    // Add stock on dropdown selection
    async function addStock(symbol) {
      const username = localStorage.getItem("username") || "user1";
      const payload = {
        username: username,
        symbol: symbol,
        quantity: 0
      };

      try {
        const response = await fetch("http://localhost:5000/customer/stocks/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          alert("Stock added successfully!");
          fetchAndRenderStocks(); // Refresh table
        } else {
          alert("Error adding stock.");
        }
      } catch (error) {
        console.error("Error adding stock:", error);
      }
    }

    // Handle dropdown change to add stock
    document.getElementById("stock-dropdown").addEventListener("change", function (event) {
      const selectedSymbol = event.target.value;
      if (selectedSymbol) {
        addStock(selectedSymbol);
      }
    });

    // Fetch and render stocks in table
    async function fetchAndRenderStocks() {
      try {
        const response = await fetch("http://localhost:5000/customer/stocks/get");
        const data = await response.json();

        const tbody = document.getElementById("stocks-table-body");
        tbody.innerHTML = ""; // Clear existing rows

        data.forEach(stock => {
          const row = document.createElement("tr");

          // Stock symbol cell
          const nameCell = document.createElement("td");
          nameCell.innerHTML = `<div class="flex items-center gap-3"><div class="font-bold">${stock.symbol}</div></div>`;
          row.appendChild(nameCell);

          // Quantity cell (editable input for updating quantity)
          const quantityCell = document.createElement("td");
          quantityCell.innerHTML = `<input type="number" value="${stock.quantity}" class="input input-bordered w-20" id="quantity-${stock.symbol}">`;
          row.appendChild(quantityCell);

          // Delete button cell
          const deleteCell = document.createElement("td");
          deleteCell.innerHTML = `<button class="btn btn-error" onclick="deleteStock('${stock.username}', '${stock.symbol}')"><i class="fa-solid fa-xmark fa-lg"></i></button>`;
          row.appendChild(deleteCell);

          // Update button cell
          const updateCell = document.createElement("td");
          updateCell.innerHTML = `<button class="btn btn-primary" onclick="updateStock('${stock.username}', '${stock.symbol}')"><i class="fa-solid fa-pen"></i> Update</button>`;
          row.appendChild(updateCell);

          tbody.appendChild(row);
        });

      } catch (error) {
        console.error("Error fetching stocks:", error);
      }
    }

    // Delete stock function
    async function deleteStock(username, symbol) {
      const payload = { username, symbol };

      try {
        const response = await fetch("http://localhost:5000/customer/stocks/delete", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          alert("Stock deleted successfully!");
          fetchAndRenderStocks(); // Refresh table
        } else {
          alert("Error deleting stock.");
        }
      } catch (error) {
        console.error(`Error deleting stock ${symbol}:`, error);
      }
    }

    // Update stock quantity function
    async function updateStock(username, symbol) {
      const quantityInput = document.getElementById(`quantity-${symbol}`);
      const newQuantity = quantityInput.value;
      const payload = { username, symbol, quantity: parseInt(newQuantity, 10) };

      try {
        const response = await fetch("http://localhost:5000/customer/stocks/update/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          alert("Stock updated successfully!");
        } else {
          alert("Error updating stock.");
        }
      } catch (error) {
        console.error(`Error updating stock ${symbol}:`, error);
      }
    }

    // Initialize page by fetching dropdown options and rendering table
    document.addEventListener("DOMContentLoaded", () => {
      fetchAndPopulateStocks();
      fetchAndRenderStocks();
    });
  </script>

</body>
</html>
