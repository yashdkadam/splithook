<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>Document</title>
  </head>
  <body>
    <div class="navbar bg-base-100">
      <div class="navbar-start">
        <div class="dropdown">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h7"
              />
            </svg>
          </div>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow"
          >
            <li><a href="/customer/stocks">Stocks</a></li>
            <li><a href="/customer/logs">Logs</a></li>
          </ul>
        </div>
      </div>
      <div class="navbar-center">
        <a class="btn btn-ghost text-2xl">SPLITHOOK</a>
      </div>
      <div class="navbar-end">
        <div class="dropdown dropdown-end">
          <div
            tabindex="0"
            role="button"
            class="btn btn-ghost btn-circle avatar"
          >
            <div class="w-10 rounded-full">
              <img
                alt="Tailwind CSS Navbar component"
                src="https://img.daisyui.com/images/stock/photo-1534528741775-53994a69daeb.webp"
              />
            </div>
          </div>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow"
          >
            <li>
              <a class="justify-between">
                Profile
                <span class="badge">New</span>
              </a>
            </li>
            <li><a>Settings</a></li>
            <li><button onclick="localStorage.clear();window.location.reload();" >Logout</button></li>

          </ul>
        </div>
      </div>
    </div>
    <!-- Dropdown for Adding Stock -->
  <div class="mb-8">
    <label class="input input-bordered flex items-center gap-2 w-64">
      <select id="stock-dropdown" class="grow border p-2 rounded-md">
        <option value="">Select a Stock to Add</option>
        <!-- Options will be dynamically populated here -->
      </select>
    </label>
  </div>

  <!-- Table for Managing Stocks -->
  <div class="overflow-x-auto">
    <table class="table w-full border">
      <!-- Table Head -->
      <thead>
        <tr>
          <th>Name</th>
          <th>Quantity</th>
          <th>Delete</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody id="stocks-table-body">
        <!-- Rows will be dynamically populated here -->
      </tbody>
    </table>
  </div>

  <script>
    // for user validation before page load
          document.addEventListener("DOMContentLoaded", async () => {
            if (
              localStorage.getItem("username") == null ||
              localStorage.getItem("type") == null)
            {
              window.location.href = '/login';
            }
          });

    // Fetch stock symbols for dropdown
    async function fetchAndPopulateStocks() {
      try {
        const response = await fetch("http://localhost:5000/admin/stocks/get");
        const stocks = await response.json();
        const dropdown = document.getElementById("stock-dropdown");

        dropdown.innerHTML = "<option value=''>Select a Stock to Add</option>";
        stocks.forEach(stock => {
          const option = document.createElement("option");
          option.value = stock;
          option.textContent = stock;
          dropdown.appendChild(option);
        });
      } catch (error) {
        console.error("Error fetching stocks:", error);
      }
    }

    // Add stock on dropdown selection
    async function addStock(symbol) {
      const username = localStorage.getItem("username") || "user1";
      const payload = {
        username: username,
        symbol: symbol,
        quantity: 0
      };

      try {
        const response = await fetch("http://localhost:5000/customer/stocks/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          console.log("Stock added successfully!");
          fetchAndRenderStocks(); // Refresh table
        } else {
          console.log("Error adding stock.");
        }
      } catch (error) {
        console.error("Error adding stock:", error);
      }
    }

    // Handle dropdown change to add stock
    document.getElementById("stock-dropdown").addEventListener("change", function (event) {
      const selectedSymbol = event.target.value;
      if (selectedSymbol) {
        addStock(selectedSymbol);
      }
    });

    // Fetch and render stocks in table
    async function fetchAndRenderStocks() {
      try {
        let username = localStorage.getItem('username');
        const response = await fetch(`http://localhost:5000/customer/stocks/get/${username}`);
        const data = await response.json();

        const tbody = document.getElementById("stocks-table-body");
        tbody.innerHTML = ""; // Clear existing rows

        data.forEach(stock => {
          const row = document.createElement("tr");

          // Stock symbol cell
          const nameCell = document.createElement("td");
          nameCell.innerHTML = `<div class="flex items-center gap-3"><div class="font-bold">${stock.symbol}</div></div>`;
          row.appendChild(nameCell);

          // Quantity cell (editable input for updating quantity)
          const quantityCell = document.createElement("td");
          quantityCell.innerHTML = `<input type="number" value="${stock.quantity}" class="input input-bordered w-20" id="quantity-${stock.symbol}">`;
          row.appendChild(quantityCell);

          // Delete button cell
          const deleteCell = document.createElement("td");
          deleteCell.innerHTML = `<button class="btn btn-error" onclick="deleteStock('${stock.username}', '${stock.symbol}')"><i class="fa-solid fa-xmark fa-lg"></i></button>`;
          row.appendChild(deleteCell);

          // Update button cell
          const updateCell = document.createElement("td");
          updateCell.innerHTML = `<button class="btn btn-primary" onclick="updateStock('${stock.username}', '${stock.symbol}')"><i class="fa-solid fa-pen"></i> Update</button>`;
          row.appendChild(updateCell);

          tbody.appendChild(row);
        });

      } catch (error) {
        console.error("Error fetching stocks:", error);
      }
    }

    // Delete stock function
    async function deleteStock(username, symbol) {
      const payload = { username, symbol };

      try {
        const response = await fetch("http://localhost:5000/customer/stocks/delete", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          console.log("Stock deleted successfully!");
          fetchAndRenderStocks(); // Refresh table
        } else {
          console.log("Error deleting stock.");
        }
      } catch (error) {
        console.error(`Error deleting stock ${symbol}:`, error);
      }
    }

    // Update stock quantity function
    async function updateStock(username, symbol) {
      const quantityInput = document.getElementById(`quantity-${symbol}`);
      const newQuantity = quantityInput.value;
      const payload = { username, symbol, quantity: parseInt(newQuantity, 10) };

      try {
        const response = await fetch("http://localhost:5000/customer/stocks/update/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          console.log("Stock updated successfully!");
        } else {
          console.log("Error updating stock.");
        }
      } catch (error) {
        console.error(`Error updating stock ${symbol}:`, error);
      }
    }

    // Initialize page by fetching dropdown options and rendering table
    document.addEventListener("DOMContentLoaded", () => {
      fetchAndPopulateStocks();
      fetchAndRenderStocks();
    });
  </script>
    </div>

    <input type="checkbox" id="my_modal_6" class="modal-toggle" />
    <div class="modal" role="dialog">
      <div class="modal-box">
        <form method="dialog">
          <label
            for="my_modal_6"
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
            >✕</label
          >
        </form>
        <h3 class="text-lg font-bold">Warning!</h3>
        <p class="py-4">Do you want to delete this stock?</p>
        <div class="flex justify-end">
          <div class="modal-action m-1">
            <label for="my_modal_6" class="btn">Yes</label>
          </div>
          <div class="modal-action m-1">
            <label for="my_modal_6" class="btn">No</label>
          </div>
        </div>
      </div>
    </div>

    <input type="checkbox" id="my_modal_7" class="modal-toggle" />
    <div class="modal" role="dialog">
      <div class="modal-box">
        <form method="dialog">
          <label
            for="my_modal_7"
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
            >✕</label
          >
        </form>
        <h3 class="text-lg font-bold my-3">Update</h3>
        <input
          type="number"
          placeholder="Quantity"
          class="input input-bordered w-full max-w-xs"
        />
        <div class="modal-action">
          <label for="my_modal_7" class="btn">Save</label>
        </div>
      </div>
    </div>

    <script src="https://cdn.tailwindcss.com"></script>
  </body>
</html>
